variables:
    CONTAINER_REGISTRY: collaborating.tuhh.de:5005
    CONTAINER_TEST_IMAGE: ${CONTAINER_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}:${CI_COMMIT_REF_SLUG}
    CONTAINER_STAGING_IMAGE: ${CONTAINER_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}:latest
    CONTAINER_STAGING_SOLR_IMAGE: ${CONTAINER_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}:solr-latest
    CONTAINER_RELEASE_IMAGE: ${CONTAINER_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}:release
    CONTAINER_RELEASE_SOLR_IMAGE: ${CONTAINER_REGISTRY}/${CI_PROJECT_NAMESPACE}/${CI_PROJECT_NAME}:solr-release
    BASE_IMAGE: ${CONTAINER_REGISTRY}/itbh/tnt/digital-learning-lab/dll-docker
    DOCKER_FILE_PATH: .

stages:
    - lint
    - register
    - test

black:
  stage: lint
  image: collaborating.tuhh.de:5005/itbh/tnt/digital-learning-lab/python-black:latest
  tags:
    - tuhh
  script:
    - black --check .


register_staging_images:
    stage: register
    before_script:
        - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CONTAINER_REGISTRY}
    script:
        - docker build --no-cache -t ${CONTAINER_STAGING_IMAGE}-staging ${DOCKER_FILE_PATH}
        - docker push ${CONTAINER_STAGING_IMAGE}-staging
    tags:
        - floki_build
    only:
        - develop

test_staging_images:
    stage: test
    image: collaborating.tuhh.de:5005/itbh/tnt/digital-learning-lab/codebasis_plattform/${CONTAINER_STAGING_IMAGE}-staging
    services:
      - postgres:12-alpine
    script:
      - coverage  run --source=dll/ -m pytest dll/
      - coverage report
    tags:
        - tuhh
    variables:
        POSTGRES_DB: "postgres"
        POSTGRES_USER: "postgres"
        POSTGRES_PASSWORD: ""
        POSTGRES_HOST_AUTH_METHOD: trust
        REDIS_HOSTNAME: "redis"
        DATABASE_USER: "postgres"
        DATABASE_NAME: "postgres"
        DATABASE_HOST: "postgres"
        DJANGO_DEBUG: "True"
        CELERY_TASK_ALWAYS_EAGER: "True"
        SOLR_HOSTNAME: "solr"
        EMAIL_HOST: "floki.rz.tuhh.de"
        EMAIL_PORT: "25"
        EMAIL_USE_TLS: "False"
        EMAIL_SENDER: "j.doe@example.com"
    only:
        - develop


register_kube_images:
    stage: register
    before_script:
        - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CONTAINER_REGISTRY}
    script:
        - docker build --no-cache -t ${CONTAINER_RELEASE_IMAGE} ${DOCKER_FILE_PATH}
        - docker push ${CONTAINER_RELEASE_IMAGE}
        #- docker build --no-cache -t ${CONTAINER_RELEASE_SOLR_IMAGE} ${DOCKER_FILE_PATH} -f Dockerfile.solr
        #- docker push ${CONTAINER_RELEASE_SOLR_IMAGE}
    tags:
        - floki_build
    only:
        - master
    when: manual

